import l,{useState as n,useEffect as S,useContext as ae,useRef as G}from"../../web_modules/react.js";import se from"../WorkflowContext.js";import y from"./SelectSearchable.js";import re from"./ConfigModal.js";import ie from"./ConfirmationModal.js";import{FontAwesomeIcon as de}from"../../web_modules/@fortawesome/react-fontawesome.js";import{faLock as me,faLockOpen as fe}from"../../web_modules/@fortawesome/free-solid-svg-icons.js";export default function pe(h){const[$,I]=n([]),[P,F]=n([]),o=ae(se),[W,M]=n(!1),[u,E]=n(!1),[p,N]=n(!1),[A,T]=n(null),[H,_]=n(!1),U=G(null),v=G(null),[x,g]=n("Save"),a=o?.currentWorkflow,d=o?.apiConfig.url,j=o?.apiConfig.token;let C=!0;const[O,J]=n([]),[B,b]=n([]),[s,R]=n(window.SelectedProjectGUID),[w,q]=n(window.SelectedTemplateGUID);S(()=>{const e={selectedProjectID:o?.currentProjectId,selectedProjectGUID:s,selectedTemplateGUID:w};for(let t in e)e[t]===void 0&&delete e[t];console.log("%c     HTML vars     ","background-color:red;color:white;",Object.keys(e).length>0?e:"No values set"),w!==void 0&&C===!0&&(D(w),C=!1),V(),Y(),o?.currentProjectId!==void 0&&L(o?.currentProjectId)},[]),S(()=>{s!==void 0&&(X(),L())},[s]),S(()=>{if(a!==void 0){if(a.StepsDelegationOfAuthorityDependant===!0){const e=a.WorkFlowTemplateSteps?.map(c=>c.WorkFlowTemplateStepItems?.every(r=>r.WorkFlowTemplateStepItemMemberPositionRoles.length>0)),t=e?.every(c=>c===!0);t===!0?E(!1):E(!0)}N(a?.TemplateLocked)}g("Save")},[a]);const k=new Headers;k.append("Authorization",`Bearer ${j}`),k.append("Content-Type","application/x-www-form-urlencoded");const f={method:"GET",headers:k,redirect:"follow"};function X(){fetch(`${d}${o?.apiConfig.templatesStem}?RootProjectGuid=${s}`,f).then(e=>e.json()).then(e=>{console.log("%c Fetching Templates List","background:pink;color:white;",e),I(e)}).catch(e=>console.log("error",e))}function D(e){console.log("----> fetchTemplate: ",e),fetch(`${d}${o?.apiConfig.templateStem}/${e}`,f).then(t=>t.json()).then(t=>{console.log("%c Fetch and set Template ","background:purple;color:white;",t),h.onChangeTemplate(t)}).catch(t=>console.log("error",t))}function z(){fetch(`${d}${o?.apiConfig.templatesStem}?RootProjectGuid=${s}`,f).then(e=>e.json()).then(e=>{console.log("%c Fetching Templates ","background:purple;color:white;",e),I(e)}).catch(e=>console.log("error",e))}function V(){fetch(`${d}${o?.apiConfig.projectsStem}`,f).then(e=>e.json()).then(e=>{F(e)}).catch(e=>console.log("error",e))}function Y(){fetch(`${d}${o?.apiConfig.doaStem}`,f).then(e=>e.json()).then(e=>{const t=o?.apiConfig.env=="prod"?e.data:e;o?.setDoa(t)}).catch(e=>console.log("error",e))}function L(){fetch(`${d}${o?.apiConfig.contactStem}`,f).then(e=>e.json()).then(e=>{console.log("%c Fetching contacts ","background:gold;color:white;",e);const t=e.filter(m=>m.User),c=t.map(m=>m.User.GUID),r=t.filter((m,i)=>!c.includes(m.User.GUID,i+1));console.log(" ----> %c Filtered: ","background:gold;color:white;",r),o?.setContacts(r)}).catch(e=>console.log("error",e))}function K(e){console.log("----> changeTemplateHandler: ",e),q(e),D(e)}function Q(e){let t=e.pageX<document.body.clientWidth-310?e.pageX+20:e.pageX-315;M(!0),T(l.createElement(re,{projectList:P,viewportPosition:{y:e.pageY+35,x:t-150},onClose:Z,onSubmit:ee}))}function Z(e){T(null)}function ee({title:e,isDOADependant:t}){console.log("Create New Template config: ",{title:e,isDOADependant:t}),h.onChangeTemplate(ne(e,t))}function te(e){oe(),_(!0)}async function oe(){try{let e=await new Promise((c,r)=>{U.current=c,v.current=r});_(!1),console.log("----> Lock confirmed!");const t={...a,TemplateLocked:!0};h.onChangeTemplate(t)}catch(e){_(!1),console.log("----> Lock cancelled")}}function le(e){console.log("Workflow to save:",a),g("Saving...");const t=new Headers;t.append("Authorization",`Bearer ${j}`),t.append("Content-Type","application/json");const c=JSON.stringify(a),r={method:"PUT",headers:t,body:c},m={method:"POST",headers:t,body:c};fetch(`${d}${o?.apiConfig.templateSaveStem}?RootProjectGuid=${s}`,W?m:r).then(i=>i.json()).then(i=>{console.log("%c Fetching Workflow ","background:red;color:white;"),console.log("----> Workflow response: ",i),g("Saved"),z(),b([i])}).catch(i=>console.log("error",i))}const ne=(e,t)=>({ProjectGUID:s,ExTrackModuleId:15,ModuleName:"Timesheets",TemplateLocked:!1,Title:e,Message:"",WorkFlowOutcomeDecidedByCode:"A",WorkFlowStepRequiredApprovalCode:"A",InitiatorOptionsStart:!1,WorkFlowInitiatorOptionsCode:"A",WorkFlowRejectionActionCode:"A",IsAutoEscalated:!1,IsSkipStepAllowed:!1,IsDelegationAllowed:!1,StepsDelegationOfAuthorityDependant:t,IsInactive:!1,IsDeleted:!1,WorkFlowTemplateSteps:[]});function ce(e){o?.setShowJson(!o?.showJson)}return l.createElement("div",{className:"App-header-content"},l.createElement("div",null,window.SelectedProjectGUID===void 0&&l.createElement("div",{className:"projectSelect"},l.createElement("h1",null,"Select a project:"),l.createElement(y,{items:P.map(e=>({label:e.ShortName,GUID:e.GUID,ProjectId:e.Id})),selectedItems:O.map(e=>({label:e.label,GUID:e.GUID,ProjectId:e.ProjectId})),allowMultiple:!1,width:"m",onSelectItem:e=>{e.length>0?(console.log("Project selected: ",e[0]),o?.setCurrentProjectId(e[0].ProjectId),R(e[0].GUID)):R(void 0),J(e)}})),s!==void 0&&l.createElement("div",{className:"templateSelect"},l.createElement("h1",null,"Select a template:"),l.createElement(y,{items:$.map(e=>({label:e.Title,GUID:e.GUID})),selectedItems:B.map(e=>({label:e.label||e.Title,GUID:e.GUID})),allowMultiple:!1,width:"m",onSelectItem:e=>{console.log("----> item: ",e),e.length>0?K(e[0].GUID):h.onChangeTemplate(void 0),b(e)}}))),s!==void 0&&l.createElement("div",null,l.createElement("button",{className:"btn",onClick:Q},"Create a new template")),l.createElement("div",null,a!==void 0&&l.createElement("div",{className:"actionBtns"},l.createElement("button",{className:"btn",onClick:te,disabled:u||p},l.createElement(de,{icon:p?me:fe}),p?"Template locked":"Lock template"),l.createElement("button",{className:"btn",onClick:le,disabled:u||p},x),l.createElement("input",{type:"checkbox",name:"showJson",id:"showJson",onChange:ce,checked:o?.showJson}),l.createElement("label",{htmlFor:"showJson",title:"Editor 210409 v.1"},"Json")),l.createElement("div",{className:"actionMsgs"},p?"Locked template cannot be Edited/Saved":u?"Please set all DOA roles to allow Locking/Saving":"")),A,H&&l.createElement(ie,{type:"lock",resolver:U.current,rejecter:v.current}))}
