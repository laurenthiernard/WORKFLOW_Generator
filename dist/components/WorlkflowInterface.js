import o,{useState as c,useEffect as k,useContext as Q}from"../../web_modules/react.js";import Z from"../WorkflowContext.js";import D from"./SelectSearchable.js";import ee from"./ConfigModal.js";import{FontAwesomeIcon as te}from"../../web_modules/@fortawesome/react-fontawesome.js";import{faLock as oe,faLockOpen as le}from"../../web_modules/@fortawesome/free-solid-svg-icons.js";export default function ne(m){const[I,R]=c([]),[S,G]=c([]),l=Q(Z),[W,L]=c(!1),[_,E]=c(!1),[f,y]=c(!1),[F,P]=c(null),[N,h]=c("Save"),a=l?.currentWorkflow,p=l?.apiConfig.url,U=l?.apiConfig.token;let T=!0;const[A,M]=c([]),[$,v]=c([]),[s,b]=c(window.SelectedProjectGUID),[g,H]=c(window.SelectedTemplateGUID);k(()=>{const e={selectedProjectID:l?.currentProjectId,selectedProjectGUID:s,selectedTemplateGUID:g};for(let t in e)e[t]===void 0&&delete e[t];console.log("%c     HTML vars     ","background-color:red;color:white;",Object.keys(e).length>0?e:"No values set"),x(),O(),l?.currentProjectId!==void 0&&j(l?.currentProjectId)},[]),k(()=>{s!==void 0&&(C(),j())},[s]),k(()=>{if(a!==void 0){if(a.StepsDelegationOfAuthorityDependant===!0){const e=a.WorkFlowTemplateSteps?.map(n=>n.WorkFlowTemplateStepItems?.every(d=>d.WorkFlowTemplateStepItemMemberPositionRoles.length>0)),t=e?.every(n=>n===!0);t===!0?E(!1):E(!0)}y(a?.TemplateLocked)}h("Save")},[a]);const w=new Headers;w.append("Authorization",`Bearer ${U}`),w.append("Content-Type","application/x-www-form-urlencoded");const u={method:"GET",headers:w,redirect:"follow"};function C(){fetch(`${p}${l?.apiConfig.templatesStem}?RootProjectGuid=${s}`,u).then(e=>e.json()).then(e=>{if(console.log("%c Fetching Templates ","background:purple;color:white;",e),g!==void 0&&T===!1){const t=e.filter(n=>n.GUID===g)[0];console.log("%c Set current Template ","background:green;color:white;",t),m.onChangeTemplate(t),T=!0}R(e)}).catch(e=>console.log("error",e))}function x(){fetch(`${p}${l?.apiConfig.projectsStem}`,u).then(e=>e.json()).then(e=>{G(e)}).catch(e=>console.log("error",e))}function O(){fetch(`${p}${l?.apiConfig.doaStem}`,u).then(e=>e.json()).then(e=>{const t=l?.apiConfig.env=="prod"?e.data:e;l?.setDoa(t)}).catch(e=>console.log("error",e))}function j(){fetch(`${p}${l?.apiConfig.contactStem}`,u).then(e=>e.json()).then(e=>{console.log("%c Fetching contacts ","background:gold;color:white;",e);const t=e.filter(i=>i.User),n=t.map(i=>i.User.GUID),d=t.filter((i,r)=>!n.includes(i.User.GUID,r+1));console.log(" ----> %c Filtered: ","background:gold;color:white;",d),l?.setContacts(d)}).catch(e=>console.log("error",e))}function J(e){console.log("----> changeTemplateHandler: ",e),H(e);const t=I.filter(n=>n.GUID===e);m.onChangeTemplate(t[0])}function B(e){let t=e.pageX<document.body.clientWidth-310?e.pageX+20:e.pageX-315;L(!0),P(o.createElement(ee,{projectList:S,viewportPosition:{y:e.pageY+35,x:t-150},onClose:q,onSubmit:X}))}function q(e){P(null)}function X({title:e,isDOADependant:t}){console.log("Create New Template config: ",{title:e,isDOADependant:t}),m.onChangeTemplate(Y(e,t))}function z(e){const t={...a,TemplateLocked:!0};m.onChangeTemplate(t)}function V(e){console.log("Workflow to save:",a),h("Saving...");const t=new Headers;t.append("Authorization",`Bearer ${U}`),t.append("Content-Type","application/json");const n=JSON.stringify(a),d={method:"PUT",headers:t,body:n},i={method:"POST",headers:t,body:n};fetch(`${p}${l?.apiConfig.templateSaveStem}?RootProjectGuid=${s}`,W?i:d).then(r=>r.json()).then(r=>{console.log("%c Fetching Workflow ","background:red;color:white;"),console.log("----> Workflow response: ",r),h("Saved"),C(),v([r])}).catch(r=>console.log("error",r))}const Y=(e,t)=>({ProjectGUID:s,ExTrackModuleId:15,ModuleName:"Timesheets",TemplateLocked:!1,Title:e,Message:"",WorkFlowOutcomeDecidedByCode:"A",WorkFlowStepRequiredApprovalCode:"A",InitiatorOptionsStart:!1,WorkFlowInitiatorOptionsCode:"A",WorkFlowRejectionActionCode:"A",IsAutoEscalated:!1,IsSkipStepAllowed:!1,IsDelegationAllowed:!1,StepsDelegationOfAuthorityDependant:t,IsInactive:!1,IsDeleted:!1,WorkFlowTemplateSteps:[]});function K(e){l?.setShowJson(!l?.showJson)}return o.createElement("div",{className:"App-header-content"},o.createElement("div",null,window.SelectedProjectGUID===void 0&&o.createElement("div",{className:"projectSelect"},o.createElement("h1",null,"Select a project:"),o.createElement(D,{items:S.map(e=>({label:e.ShortName,GUID:e.GUID,ProjectId:e.Id})),selectedItems:A.map(e=>({label:e.label,GUID:e.GUID,ProjectId:e.ProjectId})),allowMultiple:!1,width:"m",onSelectItem:e=>{e.length>0?(console.log("Project selected: ",e[0]),l?.setCurrentProjectId(e[0].ProjectId),b(e[0].GUID)):b(void 0),M(e)}})),s!==void 0&&o.createElement("div",{className:"templateSelect"},o.createElement("h1",null,"Select a template:"),o.createElement(D,{items:I.map(e=>({label:e.Title,GUID:e.GUID})),selectedItems:$.map(e=>({label:e.label||e.Title,GUID:e.GUID})),allowMultiple:!1,width:"m",onSelectItem:e=>{console.log("----> item: ",e),e.length>0?J(e[0].GUID):m.onChangeTemplate(void 0),v(e)}}))),s!==void 0&&o.createElement("div",null,o.createElement("button",{className:"btn",onClick:B},"Create a new template")),o.createElement("div",null,a!==void 0&&o.createElement("div",{className:"actionBtns"},o.createElement("button",{className:"btn",onClick:z,disabled:_||f},o.createElement(te,{icon:f?oe:le}),f?"Template locked":"Lock template"),o.createElement("button",{className:"btn",onClick:V,disabled:_||f},N),o.createElement("input",{type:"checkbox",name:"showJson",id:"showJson",onChange:K,checked:l?.showJson}),o.createElement("label",{htmlFor:"showJson",title:"Editor 210408 v.1"},"Json")),o.createElement("div",{className:"actionMsgs"},f?"Locked template cannot be Edited/Saved":_?"Please set all DOA roles to allow Locking/Saving":"")),F)}
