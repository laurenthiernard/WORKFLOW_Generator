import l,{useState as n,useEffect as _,useContext as X}from"../../web_modules/react.js";import z from"../WorkflowContext.js";import T from"./SelectSearchable.js";import V from"./ConfigModal.js";export default function Y(d){const[w,j]=n([]),[I,b]=n([]),o=X(z),[v,D]=n(!1),[G,k]=n(null),[R,h]=n("Save"),i=o?.currentWorkflow,m=o?.apiConfig.url,S=o?.apiConfig.token,[W,N]=n([]),[$,U]=n([]),[c,P]=n(window.SelectedProjectGUID),[u,y]=n(window.SelectedTemplateGUID);_(()=>{const e={selectedProjectID:o?.currentProjectId,selectedProjectGUID:c,selectedTemplateGUID:u};for(let t in e)e[t]===void 0&&delete e[t];console.log("%c     HTML vars     ","background-color:red;color:white;",Object.keys(e).length>0?e:"No values set"),A(),H(),o?.currentProjectId!==void 0&&E(o?.currentProjectId)},[]),_(()=>{c!==void 0&&(C(),E())},[c]),_(()=>{h("Save")},[i]);const g=new Headers;g.append("Authorization",`Bearer ${S}`),g.append("Content-Type","application/x-www-form-urlencoded");const f={method:"GET",headers:g,redirect:"follow"};function C(){fetch(`${m}${o?.apiConfig.templatesStem}?RootProjectGuid=${c}`,f).then(e=>e.json()).then(e=>{if(console.log("%c Fetching Templates ","background:purple;color:white;",e),u!==void 0){const t=e.filter(a=>a.GUID===u)[0];console.log("%c Set current Template ","background:green;color:white;",t),d.onChangeTemplate(t)}j(e)}).catch(e=>console.log("error",e))}function A(){fetch(`${m}${o?.apiConfig.projectsStem}`,f).then(e=>e.json()).then(e=>{b(e)}).catch(e=>console.log("error",e))}function H(){fetch(`${m}${o?.apiConfig.doaStem}`,f).then(e=>e.json()).then(e=>{const t=o?.apiConfig.env=="prod"?e.data:e;o?.setDoa(t)}).catch(e=>console.log("error",e))}function E(){fetch(`${m}${o?.apiConfig.contactStem}`,f).then(e=>e.json()).then(e=>{console.log("%c Fetching contacts ","background:gold;color:white;",e);const t=e.filter(r=>r.User),a=t.map(r=>r.User.GUID),p=t.filter((r,s)=>!a.includes(r.User.GUID,s+1));console.log(" ----> %c Filtered: ","background:gold;color:white;",p),o?.setContacts(p)}).catch(e=>console.log("error",e))}function L(e){console.log("----> changeTemplateHandler: ",e),y(e);const t=w.filter(a=>a.GUID===e);d.onChangeTemplate(t[0])}function M(e){let t=e.pageX<document.body.clientWidth-310?e.pageX+20:e.pageX-315;D(!0),k(l.createElement(V,{projectList:I,viewportPosition:{y:e.pageY+35,x:t-150},onClose:F,onSubmit:x}))}function F(e){k(null)}function x({title:e,isDOADependant:t}){console.log("Create New Template config: ",{title:e,isDOADependant:t}),d.onChangeTemplate(O(e,t))}function J(e){const t={...i,TemplateLocked:!0};d.onChangeTemplate(t)}function B(e){console.log("Workflow to save:",i),h("Saving...");const t=new Headers;t.append("Authorization",`Bearer ${S}`),t.append("Content-Type","application/json");const a=JSON.stringify(i),p={method:"PUT",headers:t,body:a},r={method:"POST",headers:t,body:a};fetch(`${m}${o?.apiConfig.templateSaveStem}?RootProjectGuid=${c}`,v?r:p).then(s=>s.json()).then(s=>{console.log("%c Fetching Workflow ","background:red;color:white;"),console.log("----> Workflow response: ",s),h("Saved"),C(),U([s])}).catch(s=>console.log("error",s))}const O=(e,t)=>({ProjectGUID:c,ExTrackModuleId:15,ModuleName:"Timesheets",TemplateLocked:!1,Title:e,Message:"",WorkFlowOutcomeDecidedByCode:"A",WorkFlowStepRequiredApprovalCode:"A",InitiatorOptionsStart:!1,WorkFlowInitiatorOptionsCode:"A",WorkFlowRejectionActionCode:"A",IsAutoEscalated:!1,IsSkipStepAllowed:!1,IsDelegationAllowed:!1,StepsDelegationOfAuthorityDependant:t,IsInactive:!1,IsDeleted:!1,WorkFlowTemplateSteps:[]});function q(e){o?.setShowJson(!o?.showJson)}return l.createElement("div",{className:"App-header-content"},l.createElement("div",null,window.SelectedProjectGUID===void 0&&l.createElement("div",{className:"projectSelect"},l.createElement("h1",null,"Select a project:"),l.createElement(T,{items:I.map(e=>({label:e.ShortName,GUID:e.GUID,ProjectId:e.Id})),selectedItems:W.map(e=>({label:e.label,GUID:e.GUID,ProjectId:e.ProjectId})),allowMultiple:!1,width:"m",onSelectItem:e=>{e.length>0?(console.log("Project selected: ",e[0]),o?.setCurrentProjectId(e[0].ProjectId),P(e[0].GUID)):P(void 0),N(e)}})),c!==void 0&&l.createElement("div",{className:"templateSelect"},l.createElement("h1",null,"Select a template:"),l.createElement(T,{items:w.map(e=>({label:e.Title,GUID:e.GUID})),selectedItems:$.map(e=>({label:e.label||e.Title,GUID:e.GUID})),allowMultiple:!1,width:"m",onSelectItem:e=>{console.log("----> item: ",e),e.length>0?L(e[0].GUID):d.onChangeTemplate(void 0),U(e)}}))),c!==void 0&&l.createElement("div",null,l.createElement("button",{className:"btn",onClick:M},"Create a new template")),i!==void 0&&l.createElement("div",{className:"actionBtns"},l.createElement("button",{className:"btn",onClick:J,disabled:i.TemplateLocked},"Lock template"),l.createElement("button",{className:"btn",onClick:B,disabled:!1},R),l.createElement("input",{type:"checkbox",name:"showJson",id:"showJson",onChange:q,checked:o?.showJson}),l.createElement("label",{htmlFor:"showJson"},"Json")),G)}
