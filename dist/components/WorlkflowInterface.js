import l,{useState as n,useEffect as u,useContext as q}from"../../web_modules/react.js";import X from"../WorkflowContext.js";import S from"./SelectSearchable.js";import z from"./ConfigModal.js";export default function V(d){const[_,E]=n([]),[g,T]=n([]),o=q(X),[Y,C]=n(!1),[b,w]=n(null),[j,I]=n("Save"),s=o?.currentWorkflow,i=o?.apiConfig.url,U=o?.apiConfig.token,[v,D]=n([]),[G,R]=n([]),[a,k]=n(window.SelectedProjectGUID),[f,N]=n(window.SelectedTemplateGUID);u(()=>{const e={selectedProjectID:o?.currentProjectId,selectedProjectGUID:a,selectedTemplateGUID:f};for(let t in e)e[t]===void 0&&delete e[t];console.log("%c     HTML vars     ","background-color:red;color:white;",Object.keys(e).length>0?e:"No values set"),y(),A(),o?.currentProjectId!==void 0&&P(o?.currentProjectId)},[]),u(()=>{a!==void 0&&(W(),P())},[a]),u(()=>{I("Save")},[s]);const p=new Headers;p.append("Authorization",`Bearer ${U}`),p.append("Content-Type","application/x-www-form-urlencoded");const m={method:"GET",headers:p,redirect:"follow"};function W(){fetch(`${i}${o?.apiConfig.templatesStem}?RootProjectGuid=${a}`,m).then(e=>e.json()).then(e=>{if(console.log("%c Fetching Templates ","background:purple;color:white;",e),f!==void 0){const t=e.filter(c=>c.GUID===f)[0];console.log("%c Set current Template ","background:green;color:white;",t),d.onChangeTemplate(t)}E(e)}).catch(e=>console.log("error",e))}function y(){fetch(`${i}${o?.apiConfig.projectsStem}`,m).then(e=>e.json()).then(e=>{T(e)}).catch(e=>console.log("error",e))}function A(){fetch(`${i}${o?.apiConfig.doaStem}`,m).then(e=>e.json()).then(e=>{const t=o?.apiConfig.env=="prod"?e.data:e;o?.setDoa(t)}).catch(e=>console.log("error",e))}function P(){fetch(`${i}${o?.apiConfig.contactStem}`,m).then(e=>e.json()).then(e=>{console.log("%c Fetching contacts ","background:gold;color:white;",e);const t=e.filter(r=>r.User),c=t.map(r=>r.User.GUID),h=t.filter((r,O)=>!c.includes(r.User.GUID,O+1));console.log(" ----> %c Filtered: ","background:gold;color:white;",h),o?.setContacts(h)}).catch(e=>console.log("error",e))}function H(e){console.log("----> changeTemplateHandler: ",e),N(e);const t=_.filter(c=>c.GUID===e);d.onChangeTemplate(t[0])}function L(e){let t=e.pageX<document.body.clientWidth-310?e.pageX+20:e.pageX-315;C(!0),w(l.createElement(z,{projectList:g,viewportPosition:{y:e.pageY+35,x:t-150},onClose:M,onSubmit:$}))}function M(e){w(null)}function $({title:e,isDOADependant:t}){console.log("Create New Template config: ",{title:e,isDOADependant:t}),d.onChangeTemplate(J(e,t))}function x(e){const t={...s,TemplateLocked:!0};d.onChangeTemplate(t)}function F(e){console.log("Workflow to save:",s),I("Saving...");const t=new Headers;t.append("Authorization",`Bearer ${U}`),t.append("Content-Type","application/json");const c=JSON.stringify(s),h={method:"PUT",headers:t,body:c},r={method:"POST",headers:t,body:c}}const J=(e,t)=>({ProjectGUID:a,ExTrackModuleId:15,ModuleName:"Timesheets",TemplateLocked:!1,Title:e,Message:"",WorkFlowOutcomeDecidedByCode:"A",WorkFlowStepRequiredApprovalCode:"A",InitiatorOptionsStart:!1,WorkFlowInitiatorOptionsCode:"A",WorkFlowRejectionActionCode:"A",IsAutoEscalated:!1,IsSkipStepAllowed:!1,IsDelegationAllowed:!1,StepsDelegationOfAuthorityDependant:t,IsInactive:!1,IsDeleted:!1,WorkFlowTemplateSteps:[]});function B(e){o?.setShowJson(!o?.showJson)}return l.createElement("div",{className:"App-header-content"},l.createElement("div",null,window.SelectedProjectGUID===void 0&&l.createElement("div",{className:"projectSelect"},l.createElement("h1",null,"Select a project:"),l.createElement(S,{items:g.map(e=>({label:e.ShortName,GUID:e.GUID,ProjectId:e.Id})),selectedItems:v.map(e=>({label:e.label,GUID:e.GUID,ProjectId:e.ProjectId})),allowMultiple:!1,width:"m",onSelectItem:e=>{e.length>0?(console.log("Project selected: ",e[0]),o?.setCurrentProjectId(e[0].ProjectId),k(e[0].GUID)):k(void 0),D(e)}})),a!==void 0&&l.createElement("div",{className:"templateSelect"},l.createElement("h1",null,"Select a template:"),l.createElement(S,{items:_.map(e=>({label:e.Title,GUID:e.GUID})),selectedItems:G.map(e=>({label:e.label||e.Title,GUID:e.GUID})),allowMultiple:!1,width:"m",onSelectItem:e=>{console.log("----> item: ",e),e.length>0?H(e[0].GUID):d.onChangeTemplate(void 0),R(e)}}))),a!==void 0&&l.createElement("div",null,l.createElement("button",{className:"btn",onClick:L},"Create a new template")),s!==void 0&&l.createElement("div",{className:"actionBtns"},l.createElement("button",{className:"btn",onClick:x,disabled:s.TemplateLocked},"Lock template"),l.createElement("button",{className:"btn",onClick:F,disabled:!1},j),l.createElement("input",{type:"checkbox",name:"showJson",id:"showJson",onChange:B,checked:o?.showJson}),l.createElement("label",{htmlFor:"showJson"},"Json")),b)}
