import n,{useState as p,useEffect as h,useContext as N}from"../../web_modules/react.js";import F from"../WorkflowContext.js";import H from"./ConfigModal.js";export default function L(m){const[w,U]=p([]),[g,C]=p([]),l=N(F),[T,P]=p(!1),[I,k]=p(null),[v,u]=p("Save"),a=l?.currentWorkflow;h(()=>{u("Save")},[a]);const s=l?.apiConfig.url,E=l?.apiConfig.token,_=new Headers;_.append("Authorization",`Bearer ${E}`),_.append("Content-Type","application/x-www-form-urlencoded");const f={method:"GET",headers:_,redirect:"follow"};h(()=>{fetch(`${s}V1.0/WorkFlow/Templates`,f).then(e=>e.json()).then(e=>{U(e)}).catch(e=>console.log("error",e))},[]),h(()=>{fetch(`${s}V1.0/Project`,f).then(e=>e.json()).then(e=>{if(C(e),a?.ProjectGUID!==void 0){const o=e.filter(t=>t.GUID==a?.ProjectGUID)[0];l?.setCurrentProjectId(o.Id),fetch(`${s}V1.0/Project/${o.Id}/Directory/Contacts`,f).then(t=>t.json()).then(t=>{const c=t.filter(d=>d.User),i=c.map(d=>d.User.GUID),r=c.filter((d,G)=>!i.includes(d.User.GUID,G+1));l?.setContacts(r)}).catch(t=>console.log("error",t))}}).catch(e=>console.log("error",e)),fetch(`${s}V1.0/WorkFlow/DelegationOfAuthority`,f).then(e=>e.json()).then(e=>{console.log("%c Fetching DOA ","background:navy;color:white;"),console.log("----> DOA response: ",e),l?.setDoa(e)}).catch(e=>console.log("error",e))},[a]);function D(e){const o=w.filter(t=>t.GUID===e.target.value)[0];e.target.value!=="none"?m.onChangeTemplate(o):m.onChangeTemplate(void 0)}function b(e){let o=e.pageX<document.body.clientWidth-310?e.pageX+20:e.pageX-315;P(!0),k(n.createElement(H,{projectList:g,viewportPosition:{y:e.pageY+35,x:o-150},onClose:j,onSubmit:R}))}function j(e){k(null)}function R({projectShortName:e,title:o,isDOADependant:t}){console.log("----> pParams: ",e,o,t),m.onChangeTemplate(y(e,o,t))}function S(e){const o={...a,TemplateLocked:!0};m.onChangeTemplate(o)}function W(e){console.log("currentWorkflow to save:",a),u("Saving...");const o=new Headers;o.append("Authorization",`Bearer ${E}`),o.append("Content-Type","application/json");const t=JSON.stringify(a),c={method:"PUT",headers:o,body:t},i={method:"POST",headers:o,body:t};fetch(`${s}V1.0/WorkFlow/Template`,T?i:c).then(r=>r.json()).then(r=>{console.log("%c Fetching Workflow ","background:red;color:white;"),console.log("----> Workflow response: ",r),u("Saved")}).catch(r=>console.log("error",r))}const y=(e,o,t)=>{const c=g.filter(i=>i.ShortName===e)[0].GUID;return console.log("ðŸš€ -> getNewTemplate -> projectGUID",c),{ProjectGUID:c,ExTrackModuleId:15,ModuleName:"Timesheets",TemplateLocked:!1,Title:o,Message:"",WorkFlowOutcomeDecidedByCode:"A",WorkFlowStepRequiredApprovalCode:"A",InitiatorOptionsStart:!1,WorkFlowInitiatorOptionsCode:"A",WorkFlowRejectionActionCode:"A",IsAutoEscalated:!1,IsSkipStepAllowed:!1,IsDelegationAllowed:!1,StepsDelegationOfAuthorityDependant:t,IsInactive:!1,IsDeleted:!1,WorkFlowTemplateSteps:[]}};function A(e){l?.setShowJson(!l?.showJson)}return n.createElement("div",{className:"App-header-content"},n.createElement("div",{className:"templateSelect"},n.createElement("h1",null,"Select a template:"),n.createElement("select",{name:"templateDropdown",id:"templateDropdown",onChange:D},n.createElement("option",{value:"none"},"-------------------"),w.map((e,o)=>n.createElement("option",{key:o,value:e.GUID},e.Title))),n.createElement("div",null,"or ",n.createElement("button",{className:"btn",onClick:b},"Create a new template"))),a!==void 0&&n.createElement("div",{className:"actionBtns"},n.createElement("button",{className:"btn",onClick:S,disabled:a.TemplateLocked},"Lock template"),n.createElement("button",{className:"btn",onClick:W,disabled:!1},v),n.createElement("input",{type:"checkbox",name:"showJson",id:"showJson",onChange:A,checked:l?.showJson}),n.createElement("label",{htmlFor:"showJson"},"Json")),I)}
