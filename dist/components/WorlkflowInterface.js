import n,{useState as p,useEffect as _,useContext as F}from"../../web_modules/react.js";import H from"../WorkflowContext.js";import L from"./ConfigModal.js";export default function x(s){const[w,E]=p([]),[g,C]=p([]),a=F(H),[I,P]=p(!1),[v,k]=p(null),[D,h]=p("Save"),l=a?.currentWorkflow;_(()=>{h("Save")},[l]);const i=a?.apiConfig.url,U=a?.apiConfig.token,u=new Headers;u.append("Authorization",`Bearer ${U}`),u.append("Content-Type","application/x-www-form-urlencoded");const f={method:"GET",headers:u,redirect:"follow"};_(()=>{T()},[]);function T(){fetch(`${i}V1.0/WorkFlow/Templates`,f).then(e=>e.json()).then(e=>{if(l!==void 0){const t=e.filter(o=>o.GUID===l.GUID)[0];console.log("ðŸš€ -> fetchTemplates -> selectedTemplate",t),s.onChangeTemplate(t)}E(e)}).catch(e=>console.log("error",e))}_(()=>{fetch(`${i}V1.0/Project`,f).then(e=>e.json()).then(e=>{if(C(e),l?.ProjectGUID!==void 0){const t=e.filter(o=>o.GUID==l?.ProjectGUID)[0];a?.setCurrentProjectId(t.Id),fetch(`${i}V1.0/Project/${t.Id}/Directory/Contacts`,f).then(o=>o.json()).then(o=>{const c=o.filter(m=>m.User),d=c.map(m=>m.User.GUID),r=c.filter((m,N)=>!d.includes(m.User.GUID,N+1));a?.setContacts(r)}).catch(o=>console.log("error",o))}}).catch(e=>console.log("error",e)),fetch(`${i}V1.0/WorkFlow/DelegationOfAuthority`,f).then(e=>e.json()).then(e=>{console.log("%c Fetching DOA ","background:navy;color:white;"),console.log("----> DOA response: ",e),a?.setDoa(e)}).catch(e=>console.log("error",e))},[l]);function b(e){const t=w.filter(o=>o.GUID===e.target.value)[0];e.target.value!=="none"?s.onChangeTemplate(t):s.onChangeTemplate(void 0)}function j(e){let t=e.pageX<document.body.clientWidth-310?e.pageX+20:e.pageX-315;P(!0),k(n.createElement(L,{projectList:g,viewportPosition:{y:e.pageY+35,x:t-150},onClose:R,onSubmit:S}))}function R(e){k(null)}function S({projectShortName:e,title:t,isDOADependant:o}){console.log("----> pParams: ",e,t,o),s.onChangeTemplate(A(e,t,o))}function W(e){const t={...l,TemplateLocked:!0};s.onChangeTemplate(t)}function y(e){console.log("currentWorkflow to save:",l),h("Saving...");const t=new Headers;t.append("Authorization",`Bearer ${U}`),t.append("Content-Type","application/json");const o=JSON.stringify(l),c={method:"PUT",headers:t,body:o},d={method:"POST",headers:t,body:o};fetch(`${i}V1.0/WorkFlow/Template`,I?d:c).then(r=>r.json()).then(r=>{console.log("%c Fetching Workflow ","background:red;color:white;"),console.log("----> Workflow response: ",r),h("Saved"),T()}).catch(r=>console.log("error",r))}const A=(e,t,o)=>{const c=g.filter(d=>d.ShortName===e)[0].GUID;return console.log("ðŸš€ -> getNewTemplate -> projectGUID",c),{ProjectGUID:c,ExTrackModuleId:15,ModuleName:"Timesheets",TemplateLocked:!1,Title:t,Message:"",WorkFlowOutcomeDecidedByCode:"A",WorkFlowStepRequiredApprovalCode:"A",InitiatorOptionsStart:!1,WorkFlowInitiatorOptionsCode:"A",WorkFlowRejectionActionCode:"A",IsAutoEscalated:!1,IsSkipStepAllowed:!1,IsDelegationAllowed:!1,StepsDelegationOfAuthorityDependant:o,IsInactive:!1,IsDeleted:!1,WorkFlowTemplateSteps:[]}};function G(e){a?.setShowJson(!a?.showJson)}return n.createElement("div",{className:"App-header-content"},n.createElement("div",{className:"templateSelect"},n.createElement("h1",null,"Select a template:"),n.createElement("select",{name:"templateDropdown",id:"templateDropdown",onChange:b},n.createElement("option",{value:"none"},"-------------------"),w.map((e,t)=>n.createElement("option",{key:t,value:e.GUID},e.Title))),n.createElement("div",null,"or ",n.createElement("button",{className:"btn",onClick:j},"Create a new template"))),l!==void 0&&n.createElement("div",{className:"actionBtns"},n.createElement("button",{className:"btn",onClick:W,disabled:l.TemplateLocked},"Lock template"),n.createElement("button",{className:"btn",onClick:y,disabled:!1},D),n.createElement("input",{type:"checkbox",name:"showJson",id:"showJson",onChange:G,checked:a?.showJson}),n.createElement("label",{htmlFor:"showJson"},"Json")),v)}
